# Восстановление пароля

## Описание функциональности

Система восстановления пароля позволяет пользователям сбросить свой пароль через временные коды.

## Как это работает

### 1. Запрос восстановления пароля
- Пользователь переходит на страницу `/forgot_password`
- Вводит свой логин
- Система создает 6-значный код восстановления

### 2. Отправка кода
Система отправляет код в следующем порядке:

1. **Через Telegram** (если у пользователя есть привязанный Telegram аккаунт)
   - Код отправляется в личные сообщения пользователю
   - Сообщение содержит код и предупреждение о безопасности

2. **Через Email** (если у пользователя есть email и настройки SMTP корректны)
   - Код отправляется на email пользователя
   - Красивое HTML письмо с кодом и инструкциями

**Важно:** Если у пользователя нет привязанного Telegram аккаунта или email, восстановление пароля невозможно.

### 3. Сброс пароля
- Пользователь переходит на страницу `/reset_password`
- Вводит полученный код
- Вводит новый пароль и подтверждение
- Система проверяет код и обновляет пароль

## Безопасность

- **Время действия кода**: 1 час
- **Одноразовое использование**: код становится недействительным после использования
- **Автоматическая очистка**: старые коды удаляются при создании новых
- **Проверка существования пользователя**: код создается только для существующих пользователей
- **Безопасная отправка**: коды отправляются только через защищенные каналы (Telegram/Email)

## Структура базы данных

### Таблица `password_reset_codes`
```sql
CREATE TABLE password_reset_codes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    login TEXT NOT NULL,
    code TEXT NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    used BOOLEAN DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Новые поля в таблице `users`
- `email TEXT` - для будущей отправки через email
- `phone TEXT` - для будущей отправки через SMS

## API методы

### `create_password_reset_code(login)`
Создает код восстановления для пользователя.

**Возвращает:**
- `(True, "Код отправлен в Telegram")` - если код отправлен через Telegram
- `(True, "Код отправлен на email")` - если код отправлен через Email
- `(False, "Ошибка")` - если пользователь не найден или нет способов отправки

### `verify_password_reset_code(login, code)`
Проверяет действительность кода восстановления.

**Возвращает:**
- `(True, reset_id)` - если код действителен
- `(False, "Ошибка")` - если код недействителен

### `mark_reset_code_used(reset_id)`
Отмечает код как использованный.

### `reset_user_password(login, new_password)`
Сбрасывает пароль пользователя.

## Веб-интерфейс

### Страницы
- `/forgot_password` - запрос восстановления пароля
- `/reset_password` - сброс пароля с кодом

### Ссылки
- На странице входа добавлена ссылка "Забыли пароль?"

## Будущие улучшения

1. **Email отправка** ✅
   - Добавлено поле email в форму регистрации
   - Реализована отправка кодов через email
   - Поддержка HTML писем с красивым дизайном

2. **SMS отправка**
   - Добавить поле телефона в форму регистрации
   - Интегрировать с SMS-сервисом

3. **Дополнительная безопасность**
   - Ограничение количества попыток восстановления
   - Логирование всех попыток восстановления
   - Уведомления о подозрительной активности

## Тестирование

Для тестирования функциональности:
1. Создайте пользователя с привязанным Telegram аккаунтом или email
2. Запросите восстановление пароля
3. Проверьте отправку кода в Telegram или на email
4. Протестируйте сброс пароля

**Важно:** Для работы восстановления пароля необходимо настроить Telegram бота или SMTP сервер. 