#!/bin/bash

echo "๐ง ะะตัะตะทะฐะฟััะบ ะฃะผะฝัะน ะฒะพะดะธัะตะปั ะฒะตะฑ-ะฟัะธะปะพะถะตะฝะธั..."

# ะััะฐะฝะพะฒะบะฐ ััะฐััั ะฟัะพัะตััะพะฒ
echo "๐ด ะััะฐะฝะพะฒะบะฐ ััะฐััั ะฟัะพัะตััะพะฒ..."
pkill -f "python.*app.py" 2>/dev/null
pkill -f "python.*web" 2>/dev/null

# ะะดะตะผ 2 ัะตะบัะฝะดั
sleep 2

# ะะตัะตัะพะด ะฒ ัะฐะฑะพััั ะดะธัะตะบัะพัะธั
cd ~/clever-driver-bot/web

# ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
echo "๐ ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
source ../venv/bin/activate

# ะัะพะฒะตัะบะฐ ััะพ Flask ัััะฐะฝะพะฒะปะตะฝ
python -c "import flask; print('โ Flask OK')" || {
    echo "โ Flask ะฝะต ะฝะฐะนะดะตะฝ! ะฃััะฐะฝะฐะฒะปะธะฒะฐั..."
    pip install flask
}

# ะัะพะฒะตัะบะฐ ััะพ ะฟัะธะปะพะถะตะฝะธะต ะธะผะฟะพััะธััะตััั
echo "๐ ะัะพะฒะตัะบะฐ ะฟัะธะปะพะถะตะฝะธั..."
python -c "from app import app; print('โ App imports OK')" || {
    echo "โ ะัะธะฑะบะฐ ะธะผะฟะพััะฐ ะฟัะธะปะพะถะตะฝะธั!"
    exit 1
}

# ะกะพะทะดะฐะตะผ ะฟะฐะฟะบั ะดะปั ะปะพะณะพะฒ ะตัะปะธ ะตั ะฝะตั
mkdir -p ../logs

# ะะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั ะฒ ัะพะฝะต
echo "๐ ะะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั..."
nohup python app.py > ../logs/web.log 2>&1 &

# ะะพะปััะฐะตะผ PID ะฟัะพัะตััะฐ
WEB_PID=$!

# ะะดะตะผ 3 ัะตะบัะฝะดั ะธ ะฟัะพะฒะตััะตะผ ััะพ ะฟัะพัะตัั ะทะฐะฟัััะธะปัั
sleep 3

if ps -p $WEB_PID > /dev/null; then
    echo "โ ะะตะฑ-ะฟัะธะปะพะถะตะฝะธะต ะทะฐะฟััะตะฝะพ! PID: $WEB_PID"
    echo "๐ ะะพะณ: tail -f ~/clever-driver-bot/logs/web.log"
    echo "๐ URL: https://cleverdriver.ru/"
    
    # ะัะพะฒะตััะตะผ ััะพ ัะตัะฒะตั ะพัะฒะตัะฐะตั
    sleep 2
    if curl -s http://localhost:5000/ > /dev/null; then
        echo "โ ะกะตัะฒะตั ะพัะฒะตัะฐะตั ะฝะฐ ะฟะพััั 5000"
    else
        echo "โ๏ธ  ะกะตัะฒะตั ะฝะต ะพัะฒะตัะฐะตั, ะฟัะพะฒะตัััะต ะปะพะณะธ"
    fi
    
else
    echo "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ! ะัะพะฒะตัััะต ะปะพะณะธ:"
    cat ../logs/web.log
    exit 1
fi

echo "๐ ะะพัะพะฒะพ! ะขะตะฟะตัั ะดะพัััะฟะฝะพ:"
echo "  ๐ฑ ะะตะณะธัััะฐัะธั: /register"
echo "  ๐ช ะัะพะด: /login"
echo "  ๐ฅ ะะดะผะธะฝะบะฐ: /admin/users"
echo "  ๏ฟฝ๏ฟฝ๏ธ ะขัะตะบะตั: /tracker" 